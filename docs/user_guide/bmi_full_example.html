
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Predict BMI &#8212; BPt 2.2.4 documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/getting_started.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/pandas.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Predicting Substance Dependence from Multi-Site Data" href="dep_full_example.html" />
    <link rel="prev" title="Extra Params" href="extra_params.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/red_logo.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../installation/index.html">
  Installation
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="index.html">
  User Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../reference/index.html">
  API reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../options/index.html">
  Default Options
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../change_log/index.html">
  Change Log
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../cite/index.html">
  Cite BPt
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/sahahn/BPt" rel="noopener" target="_blank" title="GitHub"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/SageHahn11" rel="noopener" target="_blank" title="Twitter"><span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="why_bpt.html">
   Why BPt?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="loading_data.html">
   Loading Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="saving_data.html">
   Saving Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="test_split.html">
   Test Split
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="role.html">
   Role
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="scope.html">
   Scope
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data_types.html">
   Data Types
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="data_files.html">
   Data Files
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="load_timeseries_example.html">
     Loading Fake Timeseries Surface Data
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="subjects.html">
   Subjects
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="pipeline_objects.html">
   Pipeline Objects
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="params.html">
   Params
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="extra_params.html">
   Extra Params
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Predict BMI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dep_full_example.html">
   Predicting Substance Dependence from Multi-Site Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ssrt.html">
   Predict Stop Signal Response Time (SSRT)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="waist_cm.html">
   Predict Waist Circumference with Diffusion Weighted Imaging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="sex.html">
   Predict Sex
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Preparing-Data">
   Preparing Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Single-Training-Set-Evaluation">
   Single Training Set Evaluation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#How-to-employ-Test-Set?">
   How to employ Test Set?
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Compare-&amp;-Evaluate">
   Compare &amp; Evaluate
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<section id="Predict-BMI">
<h1>Predict BMI<a class="headerlink" href="#Predict-BMI" title="Permalink to this headline">#</a></h1>
<p>This script shows a real world example using BPt to study the relationship between BMI and the brain. The data used in this notebook cannot be made public as it is from the ABCD Study, which requires a data use agreement in order to use the data.</p>
<p>This notebook covers a number of different topics:</p>
<ul class="simple">
<li><p>Preparing Data</p></li>
<li><p>Evaluating a single pipeline</p></li>
<li><p>Considering different options for how to use a test set</p></li>
<li><p>Introduce and use the Evaluate input option</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">BPt</span> <span class="k">as</span> <span class="nn">bp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Don&#39;t show sklearn convergence warnings</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">simplefilter</span>
<span class="kn">from</span> <span class="nn">sklearn.exceptions</span> <span class="kn">import</span> <span class="n">ConvergenceWarning</span>
<span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">ConvergenceWarning</span><span class="p">)</span>

<span class="c1"># Display tables up to five decimals</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:,.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
<section id="Preparing-Data">
<h2>Preparing Data<a class="headerlink" href="#Preparing-Data" title="Permalink to this headline">#</a></h2>
<p>We will first load in the underlying dataset for this project which has been saved as a csv. It contains multi-modal change in ROI data from two timepoints of the ABCD Study (difference from follow up and baseline).</p>
<p>This saved dataset doesn’t include the real family ids, but an interesting piece of the ABCD study derived data is that there are a number of subjects from the same family. We will handle that in this example (granted with a fake family structure which we will generate below) by ensuring that for any cross-validation split, members of the same family stay in the same training or testing fold.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s1">&#39;data/structure_base.xlsx&#39;</span><span class="p">)</span>
<span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;Unnamed: 0&#39;,
 &#39;src_subject_id&#39;,
 &#39;b_averaged_puberty&#39;,
 &#39;b_agemos&#39;,
 &#39;b_sex&#39;,
 &#39;b_race_ethnicity_categories&#39;,
 &#39;b_demo_highest_education_categories&#39;,
 &#39;b_site_id_l&#39;,
 &#39;b_subjects_no_missing_data&#39;,
 &#39;bmi_keep&#39;]
</pre></div></div>
</div>
<p>This dataset contains a number of columns we don’t need. We will use the next cell to both group variables of interest together, and then select only the relvant columns to keep.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Our target variable</span>
<span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;b_bmi&#39;</span><span class="p">]</span>

<span class="c1"># Columns with different traditional &#39;co-variates&#39;.</span>
<span class="n">covars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;b_sex&#39;</span><span class="p">,</span>  <span class="s1">&#39;b_demo_highest_education_categories&#39;</span><span class="p">,</span><span class="s1">&#39;b_race_ethnicity_categories&#39;</span><span class="p">,</span>
          <span class="s1">&#39;b_agemos&#39;</span><span class="p">,</span> <span class="s1">&#39;b_mri_info_deviceserialnumber&#39;</span><span class="p">]</span>

<span class="c1"># Let&#39;s also note which of these are categorical</span>
<span class="n">cat_covars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;b_mri_info_deviceserialnumber&#39;</span><span class="p">,</span>
              <span class="s1">&#39;b_demo_highest_education_categories&#39;</span><span class="p">,</span>
              <span class="s1">&#39;b_race_ethnicity_categories&#39;</span><span class="p">,</span>
              <span class="s1">&#39;b_sex&#39;</span><span class="p">]</span>

<span class="c1"># These variables are any which we might want to use</span>
<span class="c1"># but not directly as input features! E.g., we</span>
<span class="c1"># might want to use them to inform choice of cross-validation.</span>
<span class="n">non_input</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;b_rel_family_id&#39;</span><span class="p">]</span>

<span class="c1"># The different imaging features</span>
<span class="n">thick</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;thick&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">]</span>
<span class="n">area</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;smri_area_cort&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">]</span>
<span class="n">subcort</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;smri_vol&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">]</span>
<span class="n">dti_fa</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;dmri_dti_full_fa_&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">]</span>
<span class="n">dti_md</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;dmri_dti_full_md_&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">]</span>
<span class="n">brain</span> <span class="o">=</span> <span class="n">thick</span> <span class="o">+</span> <span class="n">area</span> <span class="o">+</span> <span class="n">subcort</span> <span class="o">+</span> <span class="n">dti_fa</span> <span class="o">+</span> <span class="n">dti_md</span>

<span class="c1"># All to keep</span>
<span class="n">to_keep</span> <span class="o">=</span> <span class="n">brain</span> <span class="o">+</span> <span class="n">targets</span> <span class="o">+</span> <span class="n">covars</span> <span class="o">+</span> <span class="n">non_input</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">to_keep</span><span class="p">]</span>
<span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(9724, 668)
</pre></div></div>
</div>
<p>Now let’s convert from a pandas DataFrame to a BPt Dataset.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># This is optional, to print some extra statements.</span>
<span class="n">data</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(9724, 668)
</pre></div></div>
</div>
<p>Next, we perform some actions specific to the Dataset class. These include specifying which columns are ‘target’ and ‘non input’, with any we don’t set to one these roles treated as the default role, ‘data’.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set&#39;s targets to target role</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">set_role</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">)</span>

<span class="c1"># Set non input to non input role</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">set_role</span><span class="p">(</span><span class="n">non_input</span><span class="p">,</span> <span class="s1">&#39;non input&#39;</span><span class="p">)</span>

<span class="c1"># Drop any missing values in the target variable</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_subjects_by_nan</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">)</span>

<span class="c1"># We can optional add the categories we made as scopes!</span>
<span class="n">data</span><span class="o">.</span><span class="n">add_scope</span><span class="p">(</span><span class="n">covars</span><span class="p">,</span> <span class="s1">&#39;covars&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">add_scope</span><span class="p">(</span><span class="n">cat_covars</span><span class="p">,</span> <span class="s1">&#39;cat covars&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">add_scope</span><span class="p">(</span><span class="n">thick</span><span class="p">,</span> <span class="s1">&#39;thick&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">add_scope</span><span class="p">(</span><span class="n">area</span><span class="p">,</span> <span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">add_scope</span><span class="p">(</span><span class="n">subcort</span><span class="p">,</span> <span class="s1">&#39;subcort&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">add_scope</span><span class="p">(</span><span class="n">dti_fa</span><span class="p">,</span> <span class="s1">&#39;dti_fa&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">add_scope</span><span class="p">(</span><span class="n">dti_md</span><span class="p">,</span> <span class="s1">&#39;dti_md&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">add_scope</span><span class="p">(</span><span class="n">brain</span><span class="p">,</span> <span class="s1">&#39;brain&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

<span class="c1"># Drop all NaN from any column</span>
<span class="c1"># Though BPt can generally handle NaN data fine,</span>
<span class="c1"># it makes certain pieces easier for this example as we don&#39;t have to worry</span>
<span class="c1"># about imputation.</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Just show the first few rows</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Setting NaN threshold to: 0.5
Dropped 8 Rows
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div style="float: left; padding: 10px;">
        <h3>Data</h3><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>b_agemos</th>
      <th>b_demo_highest_education_categories</th>
      <th>b_mri_info_deviceserialnumber</th>
      <th>b_race_ethnicity_categories</th>
      <th>b_sex</th>
      <th>dmri_dti_full_fa_subcort_aseg_accumbens_area_lh</th>
      <th>dmri_dti_full_fa_subcort_aseg_accumbens_area_rh</th>
      <th>dmri_dti_full_fa_subcort_aseg_amygdala_lh</th>
      <th>dmri_dti_full_fa_subcort_aseg_amygdala_rh</th>
      <th>dmri_dti_full_fa_subcort_aseg_caudate_lh</th>
      <th>...</th>
      <th>smri_vol_scs_subcorticalgv</th>
      <th>smri_vol_scs_suprateialv</th>
      <th>smri_vol_scs_tplh</th>
      <th>smri_vol_scs_tprh</th>
      <th>smri_vol_scs_vedclh</th>
      <th>smri_vol_scs_vedcrh</th>
      <th>smri_vol_scs_wholeb</th>
      <th>smri_vol_scs_wmhint</th>
      <th>smri_vol_scs_wmhintlh</th>
      <th>smri_vol_scs_wmhintrh</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>124</td>
      <td>2</td>
      <td>HASHe4f6957a</td>
      <td>2</td>
      <td>1</td>
      <td>0.17195</td>
      <td>0.17389</td>
      <td>0.19923</td>
      <td>0.16654</td>
      <td>0.15518</td>
      <td>...</td>
      <td>52,440.00000</td>
      <td>935,475.83514</td>
      <td>6,220.90000</td>
      <td>5,787.40000</td>
      <td>3,554.80000</td>
      <td>3,427.90000</td>
      <td>1,045,923.63514</td>
      <td>478.40000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>122</td>
      <td>5</td>
      <td>HASH1314a204</td>
      <td>1</td>
      <td>2</td>
      <td>0.16897</td>
      <td>0.16477</td>
      <td>0.20000</td>
      <td>0.17713</td>
      <td>0.15848</td>
      <td>...</td>
      <td>62,550.00000</td>
      <td>1,078,644.86257</td>
      <td>8,222.60000</td>
      <td>7,571.40000</td>
      <td>3,872.50000</td>
      <td>3,837.40000</td>
      <td>1,197,394.06258</td>
      <td>769.70000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>114</td>
      <td>3</td>
      <td>HASH69f406fa</td>
      <td>1</td>
      <td>1</td>
      <td>0.22881</td>
      <td>0.25250</td>
      <td>0.23221</td>
      <td>0.22298</td>
      <td>0.22545</td>
      <td>...</td>
      <td>60,695.00000</td>
      <td>1,133,471.50460</td>
      <td>7,040.50000</td>
      <td>6,752.90000</td>
      <td>4,588.80000</td>
      <td>4,631.50000</td>
      <td>1,291,126.70460</td>
      <td>1,114.70000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>130</td>
      <td>5</td>
      <td>HASH1314a204</td>
      <td>1</td>
      <td>2</td>
      <td>0.16737</td>
      <td>0.18840</td>
      <td>0.15135</td>
      <td>0.16215</td>
      <td>0.18848</td>
      <td>...</td>
      <td>65,614.00000</td>
      <td>1,055,580.45187</td>
      <td>8,365.70000</td>
      <td>7,656.40000</td>
      <td>4,600.10000</td>
      <td>4,920.60000</td>
      <td>1,189,841.05187</td>
      <td>1,788.50000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>115</td>
      <td>5</td>
      <td>HASHc3bf3d9c</td>
      <td>1</td>
      <td>2</td>
      <td>0.18902</td>
      <td>0.21375</td>
      <td>0.23945</td>
      <td>0.20581</td>
      <td>0.20100</td>
      <td>...</td>
      <td>59,174.00000</td>
      <td>1,010,567.33270</td>
      <td>6,577.90000</td>
      <td>6,612.70000</td>
      <td>3,434.30000</td>
      <td>3,942.60000</td>
      <td>1,144,069.73270</td>
      <td>1,036.30000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 666 columns</p>
</div></div>
<div style="float: left; padding: 10px;">
        <h3>Target</h3><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>b_bmi</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>15.17507</td>
    </tr>
    <tr>
      <th>1</th>
      <td>16.45090</td>
    </tr>
    <tr>
      <th>2</th>
      <td>24.43703</td>
    </tr>
    <tr>
      <th>3</th>
      <td>17.38701</td>
    </tr>
    <tr>
      <th>4</th>
      <td>17.59670</td>
    </tr>
  </tbody>
</table>
</div></div>
<div style="float: left; padding: 10px;">
        <h3>Non Input</h3><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>b_rel_family_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2257</td>
    </tr>
    <tr>
      <th>1</th>
      <td>11328</td>
    </tr>
    <tr>
      <th>2</th>
      <td>7607</td>
    </tr>
    <tr>
      <th>3</th>
      <td>11324</td>
    </tr>
    <tr>
      <th>4</th>
      <td>7608</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The scopes we defined are nice, as it lets use check columns, or compose different scopes together. For example we can check the scope we set ‘cat covars’ as composed with another variable as:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">get_cols</span><span class="p">([</span><span class="n">cat_covars</span><span class="p">,</span> <span class="s1">&#39;b_rel_family_id&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;b_demo_highest_education_categories&#39;,
 &#39;b_mri_info_deviceserialnumber&#39;,
 &#39;b_race_ethnicity_categories&#39;,
 &#39;b_rel_family_id&#39;,
 &#39;b_sex&#39;]
</pre></div></div>
</div>
<p>These are notably the columns we want to make sure are categorical, so lets ordinalize them, then plot.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ordinalize</span><span class="p">([</span><span class="n">cat_covars</span><span class="p">,</span> <span class="s1">&#39;b_rel_family_id&#39;</span><span class="p">])</span>

<span class="c1"># Then plot just the categorical variables</span>
<span class="n">data</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="n">subjects</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">decode_values</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
b_demo_highest_education_categories: 9478 rows
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/user_guide_bmi_full_example_14_1.png" src="../_images/user_guide_bmi_full_example_14_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
b_mri_info_deviceserialnumber: 9478 rows
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/user_guide_bmi_full_example_14_3.png" src="../_images/user_guide_bmi_full_example_14_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
b_race_ethnicity_categories: 9478 rows
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/user_guide_bmi_full_example_14_5.png" src="../_images/user_guide_bmi_full_example_14_5.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
b_rel_family_id: 9478 rows
b_sex: 9478 rows
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/sage/anaconda3/envs/bpt/lib/python3.9/site-packages/BPt/dataset/helpers.py:167: UserWarning: Skipping plot: b_rel_family_id as &gt;= categories!
  warnings.warn(as_str)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/user_guide_bmi_full_example_14_8.png" src="../_images/user_guide_bmi_full_example_14_8.png" />
</div>
</div>
<p>Let’s plot the target variables as well.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
b_bmi: 9478 rows
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/user_guide_bmi_full_example_16_1.png" src="../_images/user_guide_bmi_full_example_16_1.png" />
</div>
</div>
<p>Okay, we note that there are some extreme outliers.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">filter_outliers_by_std</span><span class="p">(</span><span class="n">n_std</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Dropped 1 Rows
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
b_bmi   53.90845
dtype: float64
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
b_bmi: 9477 rows
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/user_guide_bmi_full_example_19_1.png" src="../_images/user_guide_bmi_full_example_19_1.png" />
</div>
</div>
<p>Okay this maximum seem much more reasonable. Let’s also assume that there may be some extreme values present in the input data as well, and that these represet corrupted data that we therefore want to drop.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Repeat it twice, to deal with outliers at multiple scales</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">filter_outliers_by_std</span><span class="p">(</span><span class="n">n_std</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">filter_outliers_by_std</span><span class="p">(</span><span class="n">n_std</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Dropped 62 Rows
Dropped 14 Rows
</pre></div></div>
</div>
<p>Next, we consider splitting up out data with a global train and test split. This can be useful in some instances. Note that we also define a cv strategy which says to perform the train test split keeping members of the same family in the same fold.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s say we want to keep family members in the same train or test split</span>
<span class="n">cv_strategy</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">CVStrategy</span><span class="p">(</span><span class="n">groups</span><span class="o">=</span><span class="s1">&#39;b_rel_family_id&#39;</span><span class="p">)</span>

<span class="c1"># Test split</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">set_test_split</span><span class="p">(</span><span class="mf">.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">cv_strategy</span><span class="o">=</span><span class="n">cv_strategy</span><span class="p">)</span>
<span class="n">data</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Performing test split on: 9401 subjects.
random_state: 5
Test split size: 0.2

Performed train/test split
Train size: 7481
Test size:  1920
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div style="float: left; padding: 10px;">
        <h3>Data</h3><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>b_agemos</th>
      <th>b_demo_highest_education_categories</th>
      <th>b_mri_info_deviceserialnumber</th>
      <th>b_race_ethnicity_categories</th>
      <th>b_sex</th>
      <th>dmri_dti_full_fa_subcort_aseg_accumbens_area_lh</th>
      <th>dmri_dti_full_fa_subcort_aseg_accumbens_area_rh</th>
      <th>dmri_dti_full_fa_subcort_aseg_amygdala_lh</th>
      <th>dmri_dti_full_fa_subcort_aseg_amygdala_rh</th>
      <th>dmri_dti_full_fa_subcort_aseg_caudate_lh</th>
      <th>...</th>
      <th>smri_vol_scs_subcorticalgv</th>
      <th>smri_vol_scs_suprateialv</th>
      <th>smri_vol_scs_tplh</th>
      <th>smri_vol_scs_tprh</th>
      <th>smri_vol_scs_vedclh</th>
      <th>smri_vol_scs_vedcrh</th>
      <th>smri_vol_scs_wholeb</th>
      <th>smri_vol_scs_wmhint</th>
      <th>smri_vol_scs_wmhintlh</th>
      <th>smri_vol_scs_wmhintrh</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th style="background: RGBA(176, 224, 230, .25)">0</th>
      <td>124</td>
      <td>1</td>
      <td>26</td>
      <td>1</td>
      <td>0</td>
      <td>0.17195</td>
      <td>0.17389</td>
      <td>0.19923</td>
      <td>0.16654</td>
      <td>0.15518</td>
      <td>...</td>
      <td>52,440.00000</td>
      <td>935,475.83514</td>
      <td>6,220.90000</td>
      <td>5,787.40000</td>
      <td>3,554.80000</td>
      <td>3,427.90000</td>
      <td>1,045,923.63514</td>
      <td>478.40000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th style="background: RGBA(176, 224, 230, .25)">1</th>
      <td>122</td>
      <td>4</td>
      <td>2</td>
      <td>0</td>
      <td>1</td>
      <td>0.16897</td>
      <td>0.16477</td>
      <td>0.20000</td>
      <td>0.17713</td>
      <td>0.15848</td>
      <td>...</td>
      <td>62,550.00000</td>
      <td>1,078,644.86257</td>
      <td>8,222.60000</td>
      <td>7,571.40000</td>
      <td>3,872.50000</td>
      <td>3,837.40000</td>
      <td>1,197,394.06258</td>
      <td>769.70000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th style="background: RGBA(249, 121, 93, .25)">2</th>
      <td>114</td>
      <td>2</td>
      <td>13</td>
      <td>0</td>
      <td>0</td>
      <td>0.22881</td>
      <td>0.25250</td>
      <td>0.23221</td>
      <td>0.22298</td>
      <td>0.22545</td>
      <td>...</td>
      <td>60,695.00000</td>
      <td>1,133,471.50460</td>
      <td>7,040.50000</td>
      <td>6,752.90000</td>
      <td>4,588.80000</td>
      <td>4,631.50000</td>
      <td>1,291,126.70460</td>
      <td>1,114.70000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th style="background: RGBA(176, 224, 230, .25)">3</th>
      <td>130</td>
      <td>4</td>
      <td>2</td>
      <td>0</td>
      <td>1</td>
      <td>0.16737</td>
      <td>0.18840</td>
      <td>0.15135</td>
      <td>0.16215</td>
      <td>0.18848</td>
      <td>...</td>
      <td>65,614.00000</td>
      <td>1,055,580.45187</td>
      <td>8,365.70000</td>
      <td>7,656.40000</td>
      <td>4,600.10000</td>
      <td>4,920.60000</td>
      <td>1,189,841.05187</td>
      <td>1,788.50000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th style="background: RGBA(176, 224, 230, .25)">4</th>
      <td>115</td>
      <td>4</td>
      <td>20</td>
      <td>0</td>
      <td>1</td>
      <td>0.18902</td>
      <td>0.21375</td>
      <td>0.23945</td>
      <td>0.20581</td>
      <td>0.20100</td>
      <td>...</td>
      <td>59,174.00000</td>
      <td>1,010,567.33270</td>
      <td>6,577.90000</td>
      <td>6,612.70000</td>
      <td>3,434.30000</td>
      <td>3,942.60000</td>
      <td>1,144,069.73270</td>
      <td>1,036.30000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th style="background: RGBA(249, 121, 93, .25)">9717</th>
      <td>119</td>
      <td>1</td>
      <td>2</td>
      <td>2</td>
      <td>1</td>
      <td>0.16392</td>
      <td>0.17222</td>
      <td>0.19906</td>
      <td>0.17829</td>
      <td>0.15375</td>
      <td>...</td>
      <td>47,422.00000</td>
      <td>893,537.35606</td>
      <td>6,066.30000</td>
      <td>5,342.00000</td>
      <td>2,808.40000</td>
      <td>3,469.60000</td>
      <td>999,770.35606</td>
      <td>1,152.40000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th style="background: RGBA(249, 121, 93, .25)">9720</th>
      <td>129</td>
      <td>4</td>
      <td>7</td>
      <td>0</td>
      <td>1</td>
      <td>0.23469</td>
      <td>0.25338</td>
      <td>0.25971</td>
      <td>0.26321</td>
      <td>0.22641</td>
      <td>...</td>
      <td>59,348.00000</td>
      <td>1,070,071.00812</td>
      <td>7,036.60000</td>
      <td>6,669.10000</td>
      <td>3,817.40000</td>
      <td>4,103.40000</td>
      <td>1,198,435.10812</td>
      <td>794.90000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th style="background: RGBA(249, 121, 93, .25)">9721</th>
      <td>108</td>
      <td>2</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0.15469</td>
      <td>0.20223</td>
      <td>0.17145</td>
      <td>0.15300</td>
      <td>0.15900</td>
      <td>...</td>
      <td>63,328.00000</td>
      <td>1,093,051.50897</td>
      <td>8,123.20000</td>
      <td>7,346.20000</td>
      <td>3,992.80000</td>
      <td>4,219.80000</td>
      <td>1,213,030.80897</td>
      <td>805.50000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th style="background: RGBA(176, 224, 230, .25)">9722</th>
      <td>110</td>
      <td>2</td>
      <td>17</td>
      <td>0</td>
      <td>1</td>
      <td>0.16530</td>
      <td>0.22484</td>
      <td>0.19524</td>
      <td>0.16084</td>
      <td>0.16671</td>
      <td>...</td>
      <td>57,037.00000</td>
      <td>997,648.58273</td>
      <td>6,692.50000</td>
      <td>6,437.90000</td>
      <td>3,833.40000</td>
      <td>3,887.70000</td>
      <td>1,127,133.48273</td>
      <td>1,477.90000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th style="background: RGBA(176, 224, 230, .25)">9723</th>
      <td>113</td>
      <td>4</td>
      <td>26</td>
      <td>0</td>
      <td>1</td>
      <td>0.15050</td>
      <td>0.16066</td>
      <td>0.16982</td>
      <td>0.16484</td>
      <td>0.15355</td>
      <td>...</td>
      <td>61,090.00000</td>
      <td>989,701.56266</td>
      <td>7,113.50000</td>
      <td>6,835.30000</td>
      <td>4,029.60000</td>
      <td>3,826.00000</td>
      <td>1,134,202.76266</td>
      <td>2,304.80000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
  </tbody>
</table>
<p>9401 rows × 666 columns</p>
<p style="margin-top: .35em"><span style="background: RGBA(176, 224, 230, .25)">7481 rows × 666 columns - Train Set </span></p><p style="margin-top: .35em"><span style="background: RGBA(249, 121, 93, .25)">1920 rows × 666 columns - Test Set </span></p></div></div>
<div style="float: left; padding: 10px;">
        <h3>Target</h3><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>b_bmi</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th style="background: RGBA(176, 224, 230, .25)">0</th>
      <td>15.17507</td>
    </tr>
    <tr>
      <th style="background: RGBA(176, 224, 230, .25)">1</th>
      <td>16.45090</td>
    </tr>
    <tr>
      <th style="background: RGBA(249, 121, 93, .25)">2</th>
      <td>24.43703</td>
    </tr>
    <tr>
      <th style="background: RGBA(176, 224, 230, .25)">3</th>
      <td>17.38701</td>
    </tr>
    <tr>
      <th style="background: RGBA(176, 224, 230, .25)">4</th>
      <td>17.59670</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th style="background: RGBA(249, 121, 93, .25)">9717</th>
      <td>16.26895</td>
    </tr>
    <tr>
      <th style="background: RGBA(249, 121, 93, .25)">9720</th>
      <td>31.95732</td>
    </tr>
    <tr>
      <th style="background: RGBA(249, 121, 93, .25)">9721</th>
      <td>14.19771</td>
    </tr>
    <tr>
      <th style="background: RGBA(176, 224, 230, .25)">9722</th>
      <td>24.42694</td>
    </tr>
    <tr>
      <th style="background: RGBA(176, 224, 230, .25)">9723</th>
      <td>18.25486</td>
    </tr>
  </tbody>
</table>
<p>9401 rows × 1 columns</p>
<p style="margin-top: .35em"><span style="background: RGBA(176, 224, 230, .25)">7481 rows × 1 columns - Train Set </span></p><p style="margin-top: .35em"><span style="background: RGBA(249, 121, 93, .25)">1920 rows × 1 columns - Test Set </span></p></div></div>
<div style="float: left; padding: 10px;">
        <h3>Non Input</h3><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>b_rel_family_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th style="background: RGBA(176, 224, 230, .25)">0</th>
      <td>1589</td>
    </tr>
    <tr>
      <th style="background: RGBA(176, 224, 230, .25)">1</th>
      <td>7867</td>
    </tr>
    <tr>
      <th style="background: RGBA(249, 121, 93, .25)">2</th>
      <td>5174</td>
    </tr>
    <tr>
      <th style="background: RGBA(176, 224, 230, .25)">3</th>
      <td>7864</td>
    </tr>
    <tr>
      <th style="background: RGBA(176, 224, 230, .25)">4</th>
      <td>5175</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th style="background: RGBA(249, 121, 93, .25)">9717</th>
      <td>8070</td>
    </tr>
    <tr>
      <th style="background: RGBA(249, 121, 93, .25)">9720</th>
      <td>1814</td>
    </tr>
    <tr>
      <th style="background: RGBA(249, 121, 93, .25)">9721</th>
      <td>5719</td>
    </tr>
    <tr>
      <th style="background: RGBA(176, 224, 230, .25)">9722</th>
      <td>6412</td>
    </tr>
    <tr>
      <th style="background: RGBA(176, 224, 230, .25)">9723</th>
      <td>1740</td>
    </tr>
  </tbody>
</table>
<p>9401 rows × 1 columns</p>
<p style="margin-top: .35em"><span style="background: RGBA(176, 224, 230, .25)">7481 rows × 1 columns - Train Set </span></p><p style="margin-top: .35em"><span style="background: RGBA(249, 121, 93, .25)">1920 rows × 1 columns - Test Set </span></p></div></div></div>
</div>
</section>
<section id="Single-Training-Set-Evaluation">
<h2>Single Training Set Evaluation<a class="headerlink" href="#Single-Training-Set-Evaluation" title="Permalink to this headline">#</a></h2>
<p>Our Dataset is now fully prepared. We can now define and evaluate a machine learning pipeline. We will start by considering a pipeline which a few steps, these are:</p>
<ol class="arabic simple">
<li><p>Winsorize just the brain data.</p></li>
<li><p>Perform Robust Scaling on any ‘float’ type columns, ‘brain’ or ‘covars’</p></li>
<li><p>One Hot Encode any categorical features</p></li>
<li><p>Fit an Elastic-Net Regression with nested random hyper-parameter search</p></li>
</ol>
<p>Let’s use one other feature of the toolbox, that is a custom cross-validation strategy. This is the same idea that we used when defining the train-test split, but now we want it to apply both during the evaluation and during the splits made when evaluating hyper-parameters.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#1</span>
<span class="n">w_scaler</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">Scaler</span><span class="p">(</span><span class="s1">&#39;winsorize&#39;</span><span class="p">,</span> <span class="n">quantile_range</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">98</span><span class="p">),</span> <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;brain&#39;</span><span class="p">)</span>

<span class="c1">#2</span>
<span class="n">s_scaler</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">Scaler</span><span class="p">(</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>

<span class="c1">#3</span>
<span class="n">ohe</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">Transformer</span><span class="p">(</span><span class="s1">&#39;one hot encoder&#39;</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>

<span class="c1">#4</span>
<span class="n">param_search</span><span class="o">=</span><span class="n">bp</span><span class="o">.</span><span class="n">ParamSearch</span><span class="p">(</span><span class="s1">&#39;RandomSearch&#39;</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                            <span class="n">cv</span><span class="o">=</span><span class="n">bp</span><span class="o">.</span><span class="n">CV</span><span class="p">(</span><span class="n">splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">cv_strategy</span><span class="o">=</span><span class="n">cv_strategy</span><span class="p">))</span>
<span class="n">elastic</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="s1">&#39;elastic&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">param_search</span><span class="o">=</span><span class="n">param_search</span><span class="p">)</span>

<span class="c1"># Now we can actually defined the pipeline</span>
<span class="n">pipe</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span><span class="n">w_scaler</span><span class="p">,</span> <span class="n">s_scaler</span><span class="p">,</span> <span class="n">ohe</span><span class="p">,</span> <span class="n">elastic</span><span class="p">])</span>
<span class="n">pipe</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Pipeline(steps=[Scaler(extra_params={&#39;quantile_range&#39;: (2, 98)},
                       obj=&#39;winsorize&#39;, scope=&#39;brain&#39;),
                Scaler(obj=&#39;standard&#39;),
                Transformer(obj=&#39;one hot encoder&#39;, scope=&#39;category&#39;),
                Model(obj=&#39;elastic&#39;,
                      param_search=ParamSearch(cv=CV(cv_strategy=CVStrategy(groups=&#39;b_rel_family_id&#39;)),
                                               n_iter=60),
                      params=1)])
</pre></div></div>
</div>
<p>Let’s say we want to use a 5-fold CV to evaluate this model on just the training set. We can first define the cv, the same as for the param_search above, but this time with splits=5.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cv</span><span class="o">=</span><span class="n">bp</span><span class="o">.</span><span class="n">CV</span><span class="p">(</span><span class="n">splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_repeats</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cv_strategy</span><span class="o">=</span><span class="n">cv_strategy</span><span class="p">)</span>
<span class="n">cv</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CV(cv_strategy=CVStrategy(groups=&#39;b_rel_family_id&#39;), splits=5)
</pre></div></div>
</div>
<p>And we will make a problem_spec to store some common params. In this case the random state for reproducibility of results and the number of jobs to use.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use problem spec just to store n jobs and random state</span>
<span class="n">ps</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">ProblemSpec</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ps</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ProblemSpec(n_jobs=8, random_state=10)
</pre></div></div>
</div>
<p>Now we are ready to evaluate this pipeline, let’s check an example using the function evaluate.</p>
<p>We will set just one specific parameter to start, which is a scope of ‘brain’ to say we just want to run a model with just the brain features (i.e., not the co-variates)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">pipeline</span><span class="o">=</span><span class="n">pipe</span><span class="p">,</span>
                        <span class="n">dataset</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                        <span class="n">problem_spec</span><span class="o">=</span><span class="n">ps</span><span class="p">,</span>
                        <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;brain&#39;</span><span class="p">,</span>
                        <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">)</span>
<span class="n">evaluator</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "779b2929beec46d4852596afd5e13ddd", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
BPtEvaluator
------------
mean_scores = {&#39;explained_variance&#39;: 0.25655836420425737, &#39;neg_mean_squared_error&#39;: -12.15230817006252}
std_scores = {&#39;explained_variance&#39;: 0.02393695017649266, &#39;neg_mean_squared_error&#39;: 1.1099605948532965}

Saved Attributes: [&#39;estimators&#39;, &#39;preds&#39;, &#39;timing&#39;, &#39;train_subjects&#39;, &#39;val_subjects&#39;, &#39;feat_names&#39;, &#39;ps&#39;, &#39;mean_scores&#39;, &#39;std_scores&#39;, &#39;weighted_mean_scores&#39;, &#39;scores&#39;, &#39;fis_&#39;, &#39;coef_&#39;]

Available Methods: [&#39;get_preds_dfs&#39;, &#39;get_fis&#39;, &#39;get_coef_&#39;, &#39;permutation_importance&#39;]

Evaluated with:
ProblemSpec(n_jobs=8, problem_type=&#39;regression&#39;, random_state=10, scope=&#39;brain&#39;,
            scorer={&#39;explained_variance&#39;: make_scorer(explained_variance_score),
                    &#39;neg_mean_squared_error&#39;: make_scorer(mean_squared_error, greater_is_better=False)},
            subjects=&#39;train&#39;, target=&#39;b_bmi&#39;)
</pre></div></div>
</div>
<p>Wait, what subset of subjects did we use? We want to make sure we are using just the training set of subjects at this stage. We just used default for the subjects, which in this case, i.e., when their is a test set defined, uses the training set as the subjects when passed to evaluate. We can confirm this by checking the intersection of the first train and validation fold with the test subjects</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evaluator</span><span class="o">.</span><span class="n">train_subjects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">test_subjects</span><span class="p">),</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">val_subjects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">test_subjects</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(Int64Index([], dtype=&#39;int64&#39;), Int64Index([], dtype=&#39;int64&#39;))
</pre></div></div>
</div>
<p>As we can see, they are empty. We could also specify subjects=‘train’ above to make sure this behavior occured.</p>
</section>
<section id="How-to-employ-Test-Set?">
<h2>How to employ Test Set?<a class="headerlink" href="#How-to-employ-Test-Set?" title="Permalink to this headline">#</a></h2>
<p>Next, we will discuss briefly two methods of evaluating on the test set.</p>
<ol class="arabic simple">
<li><p>There is a notion in some of the literature that the test set should be used to evaluate an existing estimator. In this case, that would consist of selecting from the 5 trained models we evaluated on the train set, and testing the one which performed best.</p></li>
<li><p>On the otherhand, we could instead re-train an estimator on the full training set and then test that on the test set. This is actually the reccomended strategy, but its still worth comparing both below.</p></li>
</ol>
<p>Let’s first do strategy 1.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get best model</span>
<span class="n">best_model_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">evaluator</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="s1">&#39;explained_variance&#39;</span><span class="p">])</span>
<span class="n">best_model</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">estimators</span><span class="p">[</span><span class="n">best_model_ind</span><span class="p">]</span>

<span class="c1"># Get the correct test data - setting the problem spec</span>
<span class="c1"># as the problem spec saved when running this evaluator</span>
<span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get_Xy</span><span class="p">(</span><span class="n">problem_spec</span><span class="o">=</span><span class="n">evaluator</span><span class="o">.</span><span class="n">ps</span><span class="p">,</span>
                             <span class="n">subjects</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>

<span class="c1"># Score</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.2724861166614897
</pre></div></div>
</div>
<p>Next, lets compare that with re-training our model on the full training set, then testing.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">pipeline</span><span class="o">=</span><span class="n">pipe</span><span class="p">,</span>
                        <span class="n">dataset</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                        <span class="n">problem_spec</span><span class="o">=</span><span class="n">ps</span><span class="p">,</span>
                        <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;brain&#39;</span><span class="p">,</span> <span class="c1"># Same as before</span>
                        <span class="n">cv</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>

<span class="n">evaluator</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "8614f7705d3445d4a331bf27ea2a6ba3", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
BPtEvaluator
------------
mean_scores = {&#39;explained_variance&#39;: 0.27514029708500876, &#39;neg_mean_squared_error&#39;: -12.269150360411253}
std_scores = {&#39;explained_variance&#39;: 0.0, &#39;neg_mean_squared_error&#39;: 0.0}

Saved Attributes: [&#39;estimators&#39;, &#39;preds&#39;, &#39;timing&#39;, &#39;train_subjects&#39;, &#39;val_subjects&#39;, &#39;feat_names&#39;, &#39;ps&#39;, &#39;mean_scores&#39;, &#39;std_scores&#39;, &#39;weighted_mean_scores&#39;, &#39;scores&#39;, &#39;fis_&#39;, &#39;coef_&#39;]

Available Methods: [&#39;get_preds_dfs&#39;, &#39;get_fis&#39;, &#39;get_coef_&#39;, &#39;permutation_importance&#39;]

Evaluated with:
ProblemSpec(n_jobs=8, problem_type=&#39;regression&#39;, random_state=10, scope=&#39;brain&#39;,
            scorer={&#39;explained_variance&#39;: make_scorer(explained_variance_score),
                    &#39;neg_mean_squared_error&#39;: make_scorer(mean_squared_error, greater_is_better=False)},
            subjects=&#39;all&#39;, target=&#39;b_bmi&#39;)
</pre></div></div>
</div>
<p>Note that in this case, when cv=‘test’ then all of the subjects will be used. If we wanted to make this behavior explicit we couldpass subjects=‘all’.</p>
<p>We can see that the results difer, though not hugely. One explanation is that at these sample sizes we still get boosts in performance from sample size, which means we expect our final model trained on the full and larger training set to do better. Another contributing factor is that by selecting from the 5-folds the model which does ‘best’ we may actually be choosing an overfit model which happened to do better on its corresponding validation set. We therefore reccomend the latter strategy.</p>
<p>In fact, we can formalize this intution, and test it on just the training set. We can do this because really the first method is just a type of meta-estimator. What it does is just in an internal nesting step, trains five models and selects the best one. We can formalize this as a custom model and compare it below.</p>
<p>We will also change the pipeline being compared a little bit for simplicity, replacing the elastic net we made via BPt with the ElasticNetCV object from scikit-learn.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">cross_validate</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">ElasticNetCV</span>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">BaseEstimator</span>

<span class="k">class</span> <span class="nc">BestOfModel</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">estimator</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">estimator</span> <span class="o">=</span> <span class="n">estimator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv</span> <span class="o">=</span> <span class="n">cv</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>

        <span class="n">scores</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">estimator</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cv</span><span class="p">,</span>
                                <span class="n">return_estimator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">best_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="s1">&#39;test_score&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimator_</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;estimator&#39;</span><span class="p">][</span><span class="n">best_ind</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>


<span class="c1"># The new elastic net cv to use</span>
<span class="n">new_elastic</span> <span class="o">=</span> <span class="n">ElasticNetCV</span><span class="p">()</span>

<span class="c1"># The best of model</span>
<span class="n">best_of_model</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
    <span class="n">BestOfModel</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">new_elastic</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>

<span class="c1"># The static model</span>
<span class="n">static_model</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">new_elastic</span><span class="p">)</span>

<span class="c1"># Use the same initial steps as before, but now with the best of model and the static models</span>
<span class="n">best_of_pipe</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span><span class="n">w_scaler</span><span class="p">,</span> <span class="n">s_scaler</span><span class="p">,</span> <span class="n">ohe</span><span class="p">,</span> <span class="n">best_of_model</span><span class="p">])</span>
<span class="n">static_pipe</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span><span class="n">w_scaler</span><span class="p">,</span> <span class="n">s_scaler</span><span class="p">,</span> <span class="n">ohe</span><span class="p">,</span> <span class="n">static_model</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Let’s try the best of model first, evaluating it on the training set with 5-fold CV.</p>
<p>Note: This is going to be a bit slow as each time a model is trained in one of the 5-folds it needs to internally train 5 models. So it should take roughly 5x longer to evaluate then it’s static counterpart.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">pipeline</span><span class="o">=</span><span class="n">best_of_pipe</span><span class="p">,</span>
                        <span class="n">dataset</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                        <span class="n">problem_spec</span><span class="o">=</span><span class="n">ps</span><span class="p">,</span>
                        <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;brain&#39;</span><span class="p">,</span>
                        <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">)</span>

<span class="n">evaluator</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "44aa5bb98ff64190828b57c4cf2ef822", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
BPtEvaluator
------------
mean_scores = {&#39;explained_variance&#39;: 0.2485223109713471, &#39;neg_mean_squared_error&#39;: -12.281307958444154}
std_scores = {&#39;explained_variance&#39;: 0.024857512022276998, &#39;neg_mean_squared_error&#39;: 1.112832141546892}

Saved Attributes: [&#39;estimators&#39;, &#39;preds&#39;, &#39;timing&#39;, &#39;train_subjects&#39;, &#39;val_subjects&#39;, &#39;feat_names&#39;, &#39;ps&#39;, &#39;mean_scores&#39;, &#39;std_scores&#39;, &#39;weighted_mean_scores&#39;, &#39;scores&#39;]

Available Methods: [&#39;get_preds_dfs&#39;, &#39;permutation_importance&#39;]

Evaluated with:
ProblemSpec(n_jobs=8, problem_type=&#39;regression&#39;, random_state=10, scope=&#39;brain&#39;,
            scorer={&#39;explained_variance&#39;: make_scorer(explained_variance_score),
                    &#39;neg_mean_squared_error&#39;: make_scorer(mean_squared_error, greater_is_better=False)},
            subjects=&#39;train&#39;, target=&#39;b_bmi&#39;)
</pre></div></div>
</div>
<p>Next, let’s run its corresponding ‘static’ counterpart.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">pipeline</span><span class="o">=</span><span class="n">static_pipe</span><span class="p">,</span>
                        <span class="n">dataset</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                        <span class="n">problem_spec</span><span class="o">=</span><span class="n">ps</span><span class="p">,</span>
                        <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;brain&#39;</span><span class="p">,</span>
                        <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">)</span>

<span class="n">evaluator</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "eda02296b3b64194833272a579fc801d", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
BPtEvaluator
------------
mean_scores = {&#39;explained_variance&#39;: 0.25832965982663025, &#39;neg_mean_squared_error&#39;: -12.120236239339546}
std_scores = {&#39;explained_variance&#39;: 0.02451883500218578, &#39;neg_mean_squared_error&#39;: 1.0828442666660394}

Saved Attributes: [&#39;estimators&#39;, &#39;preds&#39;, &#39;timing&#39;, &#39;train_subjects&#39;, &#39;val_subjects&#39;, &#39;feat_names&#39;, &#39;ps&#39;, &#39;mean_scores&#39;, &#39;std_scores&#39;, &#39;weighted_mean_scores&#39;, &#39;scores&#39;, &#39;fis_&#39;, &#39;coef_&#39;]

Available Methods: [&#39;get_preds_dfs&#39;, &#39;get_fis&#39;, &#39;get_coef_&#39;, &#39;permutation_importance&#39;]

Evaluated with:
ProblemSpec(n_jobs=8, problem_type=&#39;regression&#39;, random_state=10, scope=&#39;brain&#39;,
            scorer={&#39;explained_variance&#39;: make_scorer(explained_variance_score),
                    &#39;neg_mean_squared_error&#39;: make_scorer(mean_squared_error, greater_is_better=False)},
            subjects=&#39;train&#39;, target=&#39;b_bmi&#39;)
</pre></div></div>
</div>
<p>These results confirm the intution, namely that it is better to re-train using as many subjects as possible rather than chose a ‘best model’ from an internal CV.</p>
</section>
<section id="Compare-&amp;-Evaluate">
<h2>Compare &amp; Evaluate<a class="headerlink" href="#Compare-&-Evaluate" title="Permalink to this headline">#</a></h2>
<p>Let’s now try out a newer feature the input class Compare. Let’s define as our options to compare using different subsets of the input data.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">compare_scopes</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">Compare</span><span class="p">([</span><span class="s1">&#39;covars&#39;</span><span class="p">,</span> <span class="s1">&#39;brain&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;thick&#39;</span><span class="p">,</span> <span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="s1">&#39;subcort&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;dti_fa&#39;</span><span class="p">,</span> <span class="s1">&#39;dti_md&#39;</span><span class="p">])</span>

<span class="n">evaluators</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">pipeline</span><span class="o">=</span><span class="n">pipe</span><span class="p">,</span>
                         <span class="n">scope</span><span class="o">=</span><span class="n">compare_scopes</span><span class="p">,</span>
                         <span class="n">dataset</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                         <span class="n">problem_spec</span><span class="o">=</span><span class="n">ps</span><span class="p">,</span>
                         <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">)</span>

<span class="c1"># Look at a summary of the results - note this option is only available after a call to evaluate with</span>
<span class="c1"># Compare&#39;s has been made!</span>
<span class="n">evaluators</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d7ed3886c8aa43f38561b0065f9418c4", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "2929fd8e79674b818fc19e12074164f1", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean_scores_explained_variance</th>
      <th>mean_scores_neg_mean_squared_error</th>
      <th>std_scores_explained_variance</th>
      <th>std_scores_neg_mean_squared_error</th>
      <th>mean_timing_fit</th>
      <th>mean_timing_score</th>
    </tr>
    <tr>
      <th>scope</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>covars</th>
      <td>0.11317</td>
      <td>-14.51761</td>
      <td>0.01192</td>
      <td>1.45243</td>
      <td>4.73712</td>
      <td>0.03311</td>
    </tr>
    <tr>
      <th>brain</th>
      <td>0.25656</td>
      <td>-12.15231</td>
      <td>0.02394</td>
      <td>1.10996</td>
      <td>15.58119</td>
      <td>0.05231</td>
    </tr>
    <tr>
      <th>all</th>
      <td>0.27908</td>
      <td>-11.78751</td>
      <td>0.02294</td>
      <td>1.10537</td>
      <td>15.45347</td>
      <td>0.07103</td>
    </tr>
    <tr>
      <th>thick</th>
      <td>0.10118</td>
      <td>-14.69564</td>
      <td>0.02711</td>
      <td>1.38971</td>
      <td>8.06942</td>
      <td>0.01529</td>
    </tr>
    <tr>
      <th>area</th>
      <td>0.02774</td>
      <td>-15.89653</td>
      <td>0.00991</td>
      <td>1.46288</td>
      <td>7.71240</td>
      <td>0.01417</td>
    </tr>
    <tr>
      <th>subcort</th>
      <td>0.05189</td>
      <td>-15.50615</td>
      <td>0.00831</td>
      <td>1.39405</td>
      <td>4.38906</td>
      <td>0.02439</td>
    </tr>
    <tr>
      <th>dti_fa</th>
      <td>0.10302</td>
      <td>-14.66791</td>
      <td>0.00659</td>
      <td>1.39366</td>
      <td>8.24234</td>
      <td>0.01827</td>
    </tr>
    <tr>
      <th>dti_md</th>
      <td>0.14541</td>
      <td>-13.96297</td>
      <td>0.01127</td>
      <td>1.21864</td>
      <td>8.31585</td>
      <td>0.01754</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>We can also try another method available which will run a pairwise model ttest comparison between all options</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evaluators</span><span class="o">.</span><span class="n">pairwise_t_stats</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;explained_variance&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>scope (1)</th>
      <th>scope (2)</th>
      <th>t_stat</th>
      <th>p_val</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>covars</td>
      <td>brain</td>
      <td>-11.36825</td>
      <td>0.00478</td>
    </tr>
    <tr>
      <th>1</th>
      <td>covars</td>
      <td>all</td>
      <td>-14.32368</td>
      <td>0.00193</td>
    </tr>
    <tr>
      <th>2</th>
      <td>covars</td>
      <td>thick</td>
      <td>0.86450</td>
      <td>1.00000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>covars</td>
      <td>area</td>
      <td>7.66506</td>
      <td>0.02180</td>
    </tr>
    <tr>
      <th>4</th>
      <td>covars</td>
      <td>subcort</td>
      <td>9.07301</td>
      <td>0.01145</td>
    </tr>
    <tr>
      <th>5</th>
      <td>covars</td>
      <td>dti_fa</td>
      <td>1.97369</td>
      <td>1.00000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>covars</td>
      <td>dti_md</td>
      <td>-4.56856</td>
      <td>0.14381</td>
    </tr>
    <tr>
      <th>7</th>
      <td>brain</td>
      <td>all</td>
      <td>-15.67812</td>
      <td>0.00135</td>
    </tr>
    <tr>
      <th>8</th>
      <td>brain</td>
      <td>thick</td>
      <td>30.46195</td>
      <td>0.00010</td>
    </tr>
    <tr>
      <th>9</th>
      <td>brain</td>
      <td>area</td>
      <td>17.32117</td>
      <td>0.00091</td>
    </tr>
    <tr>
      <th>10</th>
      <td>brain</td>
      <td>subcort</td>
      <td>17.40024</td>
      <td>0.00090</td>
    </tr>
    <tr>
      <th>11</th>
      <td>brain</td>
      <td>dti_fa</td>
      <td>12.94696</td>
      <td>0.00287</td>
    </tr>
    <tr>
      <th>12</th>
      <td>brain</td>
      <td>dti_md</td>
      <td>11.98864</td>
      <td>0.00388</td>
    </tr>
    <tr>
      <th>13</th>
      <td>all</td>
      <td>thick</td>
      <td>31.58027</td>
      <td>0.00008</td>
    </tr>
    <tr>
      <th>14</th>
      <td>all</td>
      <td>area</td>
      <td>19.16281</td>
      <td>0.00061</td>
    </tr>
    <tr>
      <th>15</th>
      <td>all</td>
      <td>subcort</td>
      <td>20.49440</td>
      <td>0.00047</td>
    </tr>
    <tr>
      <th>16</th>
      <td>all</td>
      <td>dti_fa</td>
      <td>15.58172</td>
      <td>0.00139</td>
    </tr>
    <tr>
      <th>17</th>
      <td>all</td>
      <td>dti_md</td>
      <td>15.37322</td>
      <td>0.00146</td>
    </tr>
    <tr>
      <th>18</th>
      <td>thick</td>
      <td>area</td>
      <td>5.10927</td>
      <td>0.09713</td>
    </tr>
    <tr>
      <th>19</th>
      <td>thick</td>
      <td>subcort</td>
      <td>3.32372</td>
      <td>0.40987</td>
    </tr>
    <tr>
      <th>20</th>
      <td>thick</td>
      <td>dti_fa</td>
      <td>-0.14599</td>
      <td>1.00000</td>
    </tr>
    <tr>
      <th>21</th>
      <td>thick</td>
      <td>dti_md</td>
      <td>-3.56252</td>
      <td>0.32946</td>
    </tr>
    <tr>
      <th>22</th>
      <td>area</td>
      <td>subcort</td>
      <td>-2.76953</td>
      <td>0.70498</td>
    </tr>
    <tr>
      <th>23</th>
      <td>area</td>
      <td>dti_fa</td>
      <td>-11.38268</td>
      <td>0.00476</td>
    </tr>
    <tr>
      <th>24</th>
      <td>area</td>
      <td>dti_md</td>
      <td>-12.59938</td>
      <td>0.00320</td>
    </tr>
    <tr>
      <th>25</th>
      <td>subcort</td>
      <td>dti_fa</td>
      <td>-7.99938</td>
      <td>0.01854</td>
    </tr>
    <tr>
      <th>26</th>
      <td>subcort</td>
      <td>dti_md</td>
      <td>-31.20696</td>
      <td>0.00009</td>
    </tr>
    <tr>
      <th>27</th>
      <td>dti_fa</td>
      <td>dti_md</td>
      <td>-6.47580</td>
      <td>0.04102</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>We can also explicitly compare two evaluators</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">e1</span> <span class="o">=</span> <span class="n">evaluators</span><span class="p">[</span><span class="s1">&#39;scope=covars&#39;</span><span class="p">]</span>
<span class="n">e2</span> <span class="o">=</span> <span class="n">evaluators</span><span class="p">[</span><span class="s1">&#39;scope=brain&#39;</span><span class="p">]</span>

<span class="c1"># Look at function docstring</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;       &#39;</span><span class="p">,</span> <span class="n">e1</span><span class="o">.</span><span class="n">compare</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="n">e1</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">e2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
        This method is designed to perform a statistical comparison
        between the results from the evaluation stored in this object
        and another instance of :class:`BPtEvaluator`. The statistics
        produced here are explained in:
        https://scikit-learn.org/stable/auto_examples/model_selection/plot_grid_search_stats.html

        .. note::
            In the case that the sizes of the training and validation sets
            at each fold vary dramatically, it is unclear if this
            statistics are still valid.
            In that case, the mean train size and mean validation sizes
            are employed when computing statistics.

        Parameters
        ------------
        other : :class:`BPtEvaluator`
            Another instance of :class:`BPtEvaluator` in which
            to compare which. The cross-validation used
            should be the same in both instances, otherwise
            statistics will not be generated.

        rope_interval : list or dict of
            | This parameter allows for passing in a custom
                region of practical equivalence interval (or rope interval)
                a concept from bayesian statistics. If passed as
                a list, this should be a list with two elements, describing
                the difference in score which should be treated as two
                models or runs being practically equivalent.

            | Alternatively, in the case of multiple underlying
                scorers / metrics. A dictionary, where keys correspond
                to scorer / metric names can be passed with a separate
                rope_interval for each. For example:

            ::

                rope_interval = {&#39;explained_variance&#39;: [-0.01, 0.01],
                                 &#39;neg_mean_squared_error&#39;: [-1, 1]}

            This example would define separate rope regions depending
            on the metric.

            ::

                default = [-0.01, 0.01]

        Returns
        -------
        compare_df : pandas DataFrame
            | The returned DataFrame will generate separate rows
                for all overlapping metrics / scorers between the
                evaluators being compared. Further, columns with
                statistics of interest will be generated:

                - &#39;mean_diff&#39;
                    The mean score minus other&#39;s mean score

                - &#39;std_diff&#39;
                    The std minus other&#39;s std

            | Further, only in the case that the cross-validation
                folds are identical between the comparisons,
                the following additional columns will be generated:

                - &#39;t_stat&#39;
                    Corrected paired ttest statistic.

                - &#39;p_val&#39;
                    The p value for the corrected paired ttest statistic.

                - &#39;better_prob&#39;
                    The probability that this evaluated option is better than
                    the other evaluated option under a bayesian framework and
                    the passed value of rope_interval. See sklearn example
                    for more details.

                - &#39;worse_prob&#39;
                    The probability that this evaluated option is worse than
                    the other evaluated option under a bayesian framework and
                    the passed value of rope_interval. See sklearn example
                    for more details.

                - &#39;rope_prob&#39;
                    The probability that this evaluated option is equivalent to
                    the other evaluated option under a bayesian framework and
                    the passed value of rope_interval. See sklearn example
                    for more details.



</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean_diff</th>
      <th>std_diff</th>
      <th>t_stat</th>
      <th>p_val</th>
      <th>better_prob</th>
      <th>worse_prob</th>
      <th>rope_prob</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>explained_variance</th>
      <td>-0.14339</td>
      <td>-0.01202</td>
      <td>-11.36825</td>
      <td>0.00017</td>
      <td>0.00013</td>
      <td>0.99977</td>
      <td>0.00009</td>
    </tr>
    <tr>
      <th>neg_mean_squared_error</th>
      <td>-2.36530</td>
      <td>0.34247</td>
      <td>-8.09697</td>
      <td>0.00063</td>
      <td>0.00062</td>
      <td>0.99936</td>
      <td>0.00002</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Okay so it looks like it ran all the different combinations, but how do we look at each indivudal evaluator / the full results?? There are few different ways to index the object storing the different evaluators, but its essentially a dictionary. We can index one run as follows:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evaluators</span><span class="p">[</span><span class="s1">&#39;scope=covars&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
BPtEvaluator
------------
mean_scores = {&#39;explained_variance&#39;: 0.11316930054010477, &#39;neg_mean_squared_error&#39;: -14.517611278919068}
std_scores = {&#39;explained_variance&#39;: 0.011916342728361404, &#39;neg_mean_squared_error&#39;: 1.4524277905958483}

Saved Attributes: [&#39;estimators&#39;, &#39;preds&#39;, &#39;timing&#39;, &#39;train_subjects&#39;, &#39;val_subjects&#39;, &#39;feat_names&#39;, &#39;ps&#39;, &#39;mean_scores&#39;, &#39;std_scores&#39;, &#39;weighted_mean_scores&#39;, &#39;scores&#39;, &#39;fis_&#39;, &#39;coef_&#39;]

Available Methods: [&#39;get_preds_dfs&#39;, &#39;get_fis&#39;, &#39;get_coef_&#39;, &#39;permutation_importance&#39;]

Evaluated with:
ProblemSpec(n_jobs=8, problem_type=&#39;regression&#39;, random_state=10,
            scope=&#39;covars&#39;,
            scorer={&#39;explained_variance&#39;: make_scorer(explained_variance_score),
                    &#39;neg_mean_squared_error&#39;: make_scorer(mean_squared_error, greater_is_better=False)},
            subjects=&#39;train&#39;, target=&#39;b_bmi&#39;)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note, with get_fis, if mean=True it will return</span>
<span class="c1"># the mean and only non-null, and non-zero features directly.</span>
<span class="n">evaluators</span><span class="p">[</span><span class="s1">&#39;scope=covars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_fis</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
b_demo_highest_education_categories=1           0.59780
b_demo_highest_education_categories=2           0.62281
b_demo_highest_education_categories=4          -0.79331
b_demo_highest_education_categories=5          -1.12268
b_mri_info_deviceserialnumber=&#39;HASH03db707f&#39;    0.17417
b_mri_info_deviceserialnumber=&#39;HASH11ad4ed5&#39;   -0.60833
b_mri_info_deviceserialnumber=&#39;HASH1314a204&#39;   -0.70919
b_mri_info_deviceserialnumber=&#39;HASH311170b9&#39;   -0.14871
b_mri_info_deviceserialnumber=&#39;HASH3935c89e&#39;   -0.42419
b_mri_info_deviceserialnumber=&#39;HASH4b0b8b05&#39;    0.02187
b_mri_info_deviceserialnumber=&#39;HASH5ac2b20b&#39;   -0.00810
b_mri_info_deviceserialnumber=&#39;HASH5b0cf1bb&#39;    0.02770
b_mri_info_deviceserialnumber=&#39;HASH5b2fcf80&#39;   -0.32682
b_mri_info_deviceserialnumber=&#39;HASH65b39280&#39;    0.44976
b_mri_info_deviceserialnumber=&#39;HASH69f406fa&#39;    0.00030
b_mri_info_deviceserialnumber=&#39;HASH6b4422a7&#39;    0.09136
b_mri_info_deviceserialnumber=&#39;HASH7911780b&#39;    0.73788
b_mri_info_deviceserialnumber=&#39;HASH7f91147d&#39;   -0.05698
b_mri_info_deviceserialnumber=&#39;HASH96a0c182&#39;   -0.01863
b_mri_info_deviceserialnumber=&#39;HASHa3e45734&#39;   -0.09858
b_mri_info_deviceserialnumber=&#39;HASHb640a1b8&#39;    0.56248
b_mri_info_deviceserialnumber=&#39;HASHc3bf3d9c&#39;    0.10516
b_mri_info_deviceserialnumber=&#39;HASHd422be27&#39;    0.00579
b_mri_info_deviceserialnumber=&#39;HASHd7cb4c6d&#39;    0.01132
b_mri_info_deviceserialnumber=&#39;HASHdb2589d4&#39;    0.00784
b_mri_info_deviceserialnumber=&#39;HASHe4f6957a&#39;   -0.19978
b_mri_info_deviceserialnumber=&#39;HASHfeb7e81a&#39;    0.03217
b_race_ethnicity_categories=1                  -0.73047
b_race_ethnicity_categories=2                   0.87523
b_race_ethnicity_categories=3                   0.74217
b_race_ethnicity_categories=4                  -0.32284
b_sex=1                                        -0.08126
b_sex=2                                         0.07723
b_agemos                                        0.39502
dtype: float64
</pre></div></div>
</div>
<p>Warning: This doesn’t mean that this mean features were selected! Remember this is the average over training 5 models, so it means that if a feature shows up it was selected at least once in one of the models!</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># These are the different options</span>
<span class="n">evaluators</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dict_keys([Options(scope=covars), Options(scope=brain), Options(scope=all), Options(scope=thick), Options(scope=area), Options(scope=subcort), Options(scope=dti_fa), Options(scope=dti_md)])
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


              </div>
              
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2020-2022.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.2.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>